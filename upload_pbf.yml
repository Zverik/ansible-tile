---
# Uploads a fresh osm.pbf to a tile server.
#
# Parameters:
# - pbf: name of a pbf file to upload
# - state: optional, number of the last minutely diff applied to that pbf
# - bounds: optional, geojson file with trim bounds
#
- hosts: all
  remote_user: zverik
  vars:
    style: "{{ style | default('/opt/styles/veloroad/veloroad.style') }}"
    database: "{{ gisdb }}"
    planet: /var/tmp/planet.osm.pbf
    render_user: osm
  tasks:
    - name: Upload pbf
      copy:
        src: "{{ pbf }}"
        dest: "{{ planet }}"
        force: yes

    - name: Stop db updates
      cron:
        name: replication
        disabled: yes
        user: "{{ render_user }}"

    - name: Stop renderd
      become: yes
      systemd: name=renderd state=stopped

    - name: Install osmium-tool
      become: yes
      apt: pkg=osmium-tool state=present

    - name: Get timestamp of the last change in the file
      command: osmium fileinfo -e --no-progress -g data.timestamp.last "{{ planet }}"
      register: lastdate
      changed_when: False

    - name: Import pbf
      become_user: "{{ render_user }}"
      become: yes
      command: osm2pgsql -C {{ ansible_memtotal_mb - 100 }} --slim -S "{{ style }}" -d {{ database }} --number-processes 2 "{{ planet }}"
      async: 3600

    - name: Remove pbf
      file:
        name: "{{ planet }}"
        state: absent

    - name: Update replication state
      when: state
      lineinfile:
        name: /var/lib/mod_tile/.osmosis/state.txt
        regexp: '^sequenceNumber'
        line: "sequenceNumber={{ state }}"

    - name: Download relevant state
      when: not state
      get_url:
        url: "https://replicate-sequences.osm.mazdermind.de/?{{ lastdate.stdout }}"
        dest: /var/lib/mod_tile/.osmosis/state.txt

    - name: Update bounds for trim_osc
      when: bounds
      copy:
        src: "{{ bounds }}"
        dest: /opt/styles/bounds.json

    - name: Update bounds for nik4wsgi
      when: bounds
      copy:
        src: "{{ bounds }}"
        dest: /opt/src/nik4wsgi/www/static/bounds.geojson
    
    - name: Start db updates
      cron:
        name: replication
        disabled: no
        user: "{{ render_user }}"

    - name: Start renderd
      become: yes
      systemd: name=renderd state=started
