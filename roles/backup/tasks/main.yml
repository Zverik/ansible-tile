---
- name: Download borg
  get_url:
    url: "https://github.com/borgbackup/borg/releases/download/{{ borg_version }}/borg-linux64"
    dest: /usr/local/bin/borg
    mode: 0755
    checksum: "md5:{{ borg_exec_md5 }}"

- name: Create a private key
  copy:
    content: "{{ borg_key }}"
    dest: /root/.ssh/borg
    mode: 0600

- name: Add rsync.net to authorized keys
  known_hosts:
    host: ch-s012.rsync.net
    key: "{{ rsync_key }}"

- name: Upload borg_env
  template:
    src: borg_env.j2
    dest: /root/borg_env
    mode: 0700

- name: Add compacting job once a week
  copy:
    src: compact_backups
    dest: /etc/cron.weekly/compact_backups
    mode: 0700

- name: Upload the backup script
  copy:
    src: make_backup
    dest: /root/make_backup
    mode: 0700

- name: Upload the extraction script
  copy:
    src: extract_backup
    dest: /root/extract_backup
    mode: 0700

- name: Set up home backups
  import_tasks: home.yml
